<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meme Wolf - Pro Admin Panel (NO LOGIN - LOCAL USE ONLY)</title> {/* Changed Title */}
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- Global Styles & Reset (Keep ALL CSS from previous version) --- */
        :root {
            --admin-bg: #ecf0f5; --sidebar-bg: #222d32; --sidebar-text: #b8c7ce; --sidebar-hover-bg: #1e282c; --sidebar-hover-text: #ffffff; --header-bg: #3c8dbc; --header-text: #ffffff; --box-blue: #00c0ef; --box-green: #00a65a; --box-yellow: #f39c12; --box-red: #dd4b39; --box-aqua: #0073b7; --box-purple: #605ca8; --link-color: #3c8dbc; --button-primary-bg: #3c8dbc; --button-primary-hover-bg: #367fa9; --button-danger-bg: #dd4b39; --button-danger-hover-bg: #d73925; --button-success-bg: #00a65a; --button-success-hover-bg: #008d4c; --button-warning-bg: #f39c12; --button-warning-hover-bg: #e08e0b; --text-color-dark: #333; --danger-text: #dd4b39; --text-muted: #777;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: var(--admin-bg); font-size: 14px; color: var(--text-color-dark); display: flex; min-height: 100vh; flex-direction: column; }
        a { color: var(--link-color); text-decoration: none; }
        a:hover { color: #72afd2; }

        /* --- Login --- REMOVED --- */

        .security-warning { /* Keep this style for warnings inside the panel */
            color: var(--danger-text); font-weight: bold; margin-bottom: 15px; border: 1px solid var(--danger-text); padding: 8px; background-color: #ffebee; border-radius: 3px; text-align: left; font-size: 0.9em;
        }
        .security-warning strong { color: #c62828; }

        /* --- Layout --- */
        /* Make admin wrapper visible by default */
        #admin-wrapper { display: flex; flex-direction: column; flex-grow: 1; }
        .main-header { background-color: var(--header-bg); color: var(--header-text); padding: 0 15px; height: 50px; display: flex; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; left: 0; z-index: 1001; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .logo { font-size: 1.5em; font-weight: bold; color: var(--header-text); text-decoration: none; }
        .logo:hover { text-decoration: none; color: #f1f1f1; }
        .navbar-custom-menu { display: flex; align-items: center; }
        /* Removed logout button styles implicitly by removing button */

        .main-sidebar { position: fixed; top: 50px; left: 0; bottom: 0; width: 230px; background-color: var(--sidebar-bg); color: var(--sidebar-text); padding-top: 15px; z-index: 1000; overflow-y: auto; transition: width 0.3s ease; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; }
        .sidebar-menu li a { display: flex; align-items: center; padding: 12px 15px; color: var(--sidebar-text); transition: background-color 0.2s, color 0.2s; white-space: nowrap; overflow: hidden; }
        .sidebar-menu li a:hover { background-color: var(--sidebar-hover-bg); color: var(--sidebar-hover-text); }
        .sidebar-menu li.active > a { background-color: var(--sidebar-hover-bg); color: var(--sidebar-hover-text); font-weight: bold; }
        .sidebar-menu li a .material-icons { vertical-align: middle; margin-right: 8px; font-size: 18px; min-width: 20px; }
        .content-wrapper { margin-top: 50px; margin-left: 230px; padding: 20px; background-color: var(--admin-bg); flex-grow: 1; transition: margin-left 0.3s ease; }
        .content-header { margin-bottom: 20px; border-bottom: 1px solid #d2d6de; padding-bottom: 10px;}
        .content-header h1 { font-size: 1.8em; margin: 0; font-weight: 400; }
        .content-header small { font-size: 0.7em; color: var(--text-muted); margin-left: 5px;}
        .content-section { display: none; animation: fadeIn 0.4s ease-out; }
        .content-section.active { display: block; }

        /* --- Components (Keep ALL from previous version) --- */
        .info-box-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .info-box { background-color: white; border-radius: 3px; padding: 15px; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s ease; }
        .info-box:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .info-box-icon { width: 70px; height: 70px; border-radius: 3px; display: flex; justify-content: center; align-items: center; font-size: 36px; color: white; margin-right: 15px; flex-shrink: 0; }
        .info-box-content { flex-grow: 1; }
        .info-box-text { text-transform: uppercase; font-size: 0.9em; color: var(--text-muted); display: block; margin-bottom: 2px; }
        .info-box-number { font-size: 1.8em; font-weight: bold; color: var(--text-color-dark); display: block; line-height: 1.2; }
        .bg-aqua { background-color: var(--box-aqua); } .bg-green { background-color: var(--box-green); } .bg-yellow { background-color: var(--box-yellow); } .bg-red { background-color: var(--box-red); } .bg-blue { background-color: var(--box-blue); } .bg-purple { background-color: var(--box-purple); }

        .box { background-color: #fff; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 3px solid var(--button-primary-bg); }
        .box-header { padding: 10px 15px; border-bottom: 1px solid #f4f4f4; display: flex; justify-content: space-between; align-items: center; }
        .box-title { font-size: 1.2em; font-weight: 600; margin: 0; }
        .box-tools { display: flex; gap: 5px; }
        .box-body { padding: 15px; }
        .box-footer { padding: 10px 15px; border-top: 1px solid #f4f4f4; background-color: #f9f9f9; text-align: right; }

        .table { width: 100%; border-collapse: collapse; margin-bottom: 15px; background-color: #fff; }
        .table th, .table td { border: 1px solid #f4f4f4; padding: 8px 10px; text-align: left; vertical-align: middle; font-size: 0.9em; }
        .table th { background-color: #f9f9f9; font-weight: 600; white-space: nowrap; }
        .table td .material-icons { font-size: 18px; vertical-align: middle; }
        .table-actions { white-space: nowrap; }
        .table-actions button { margin: 1px 2px; padding: 3px 6px; font-size: 0.8em; }
        .table tbody tr:hover { background-color: #f5f5f5; }
        .table-striped tbody tr:nth-of-type(odd) { background-color: #f9f9f9; }
        .table-striped tbody tr:nth-of-type(odd):hover { background-color: #f0f0f0; }
        .table-empty-row td { text-align: center; color: var(--text-muted); padding: 20px; font-style: italic; }

        /* --- Forms & Buttons (Keep ALL from previous version) --- */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.95em; }
        .form-control { width: 100%; padding: 8px 10px; border: 1px solid #d2d6de; border-radius: 3px; font-size: 1em; box-shadow: inset 0 1px 1px rgba(0,0,0,.075); transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s; }
        .form-control:focus { border-color: var(--link-color); outline: 0; box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(60, 141, 188, 0.6); }
        select.form-control { height: 34px; appearance: none; -webkit-appearance: none; background: white url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E') no-repeat right .75rem center/8px 10px; padding-right: 25px; }
        textarea.form-control { min-height: 80px; }
        input[type="datetime-local"].form-control, input[type="number"].form-control { height: 34px; }
        input[type="url"].form-control { font-family: monospace; }

        .btn { border: none; border-radius: 3px; padding: 6px 12px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; line-height: 1.42857143; vertical-align: middle; text-align: center; white-space: nowrap; }
        .btn:disabled { cursor: not-allowed; opacity: 0.65; }
        .btn:active { box-shadow: inset 0 3px 5px rgba(0,0,0,.125); }
        .btn-primary { background-color: var(--button-primary-bg); color: white; border: 1px solid var(--button-primary-bg); } .btn-primary:hover { background-color: var(--button-primary-hover-bg); border-color: var(--button-primary-hover-bg); }
        .btn-danger { background-color: var(--button-danger-bg); color: white; border: 1px solid var(--button-danger-bg); } .btn-danger:hover { background-color: var(--button-danger-hover-bg); border-color: var(--button-danger-hover-bg); }
        .btn-success { background-color: var(--button-success-bg); color: white; border: 1px solid var(--button-success-bg); } .btn-success:hover { background-color: var(--button-success-hover-bg); border-color: var(--button-success-hover-bg); }
        .btn-warning { background-color: var(--button-warning-bg); color: white; border: 1px solid var(--button-warning-bg); } .btn-warning:hover { background-color: var(--button-warning-hover-bg); border-color: var(--button-warning-hover-bg); }
        .btn-default { background-color: #f4f4f4; color: #444; border: 1px solid #ddd; } .btn-default:hover { background-color: #e7e7e7; border-color: #ccc; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-xs { padding: 2px 6px; font-size: 12px; }
        .btn .material-icons { font-size: 1.2em; line-height: 1; }
        .pull-right { float: right !important; }

        /* --- Messages & Status (Keep ALL from previous version) --- */
        .form-status, .modal-status { min-height: 1.5em; font-weight: bold; margin-top: 10px; padding: 5px 0; }
        .error-message { color: var(--box-red); font-size: 0.9em; }
        .success-message { color: var(--box-green); font-size: 0.9em; }
        .loading-message { color: var(--text-muted); font-style: italic; font-size: 0.9em;}
        .text-red { color: var(--box-red) !important; }
        .text-green { color: var(--box-green) !important; }
        .text-muted { color: var(--text-muted) !important; }
        .text-bold { font-weight: bold !important; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; flex-shrink: 0; }
        .status-active { background-color: var(--box-green); }
        .status-banned { background-color: var(--box-red); }
        .status-expired { background-color: #777; }
        .status-inactive { background-color: #bbb; }
        .dimmed { opacity: 0.6; font-style: italic; }

        /* --- Modals (Keep ALL from previous version) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1050; backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); animation: fadeIn 0.3s ease-out; padding: 15px; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: white; color: var(--text-color-dark); padding: 0; border-radius: 5px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 100%; max-width: 650px; text-align: left; animation: slideIn 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #e5e5e5; background-color: #f9f9f9; }
        .modal-title { font-size: 1.3em; font-weight: 600; color: var(--text-color-dark); margin: 0; line-height: 1.4; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1;}
        .modal-input { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 3px; border: 1px solid #ccc; background-color: #fff; color: var(--text-color-dark); font-size: 1em; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; padding: 15px 20px; border-top: 1px solid #eee; background-color: #f5f5f5; }
        .modal-button { /* Inherits .btn styles */ }
        .modal-button.cancel { background: #aaa; color: white; border-color: #aaa; } .modal-button.cancel:hover { background: #999; border-color: #999; }

        /* --- Specific Components (Keep ALL from previous version) --- */
        .inline-button-group { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 3px; background-color: #fafafa; }
        .inline-button-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .inline-button-row input { flex: 1; }
        .inline-button-row button { flex-shrink: 0; }
        #autopilot-info { font-size: 0.9em; color: #555; margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 3px; }
        .time-input-group { display: flex; gap: 10px; align-items: baseline; flex-wrap: wrap; }
        .time-input-group > div { flex: 1; min-width: 80px; }
        .time-input-group label { font-size: 0.85em; color: #555; display: block; text-align: center; margin-bottom: 2px;}
        .time-input-group input { text-align: center; }
        #task-table img, #template-table img { width: 30px; height: 30px; border-radius: 3px; vertical-align: middle; margin-right: 8px; object-fit: cover; background-color: #eee; }
        .label { display: inline-block; padding: .2em .6em .3em; font-size: 75%; font-weight: 700; line-height: 1; color: #fff; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: .25em; }
        .label.bg-purple { background-color: var(--box-purple); }
        .label.bg-blue { background-color: var(--box-blue); }
        code { background-color: #f1f1f1; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .task-status-icon { font-size: 1.2em; vertical-align: middle; }

        /* --- Animations (Keep ALL from previous version) --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Removed shake animation as login error is gone */

        /* --- Flash Message Style (Keep ALL from previous version) --- */
        .flash-message { position: fixed; top: 60px; right: 20px; padding: 12px 20px; border-radius: 4px; color: #fff; z-index: 2010; opacity: 0; transform: translateX(100%); box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
        .flash-message.show { opacity: 0.95; transform: translateX(0); }
        .flash-message.success { background-color: var(--box-green); }
        .flash-message.warning { background-color: var(--box-yellow); }
        .flash-message.error { background-color: var(--box-red); }
        .flash-message.info { background-color: var(--box-blue); }

    </style>
</head>
<body>

    <!-- Login Screen REMOVED -->

    <!-- Main Admin Panel (Visible by default) -->
    <div id="admin-wrapper">
        <header class="main-header">
            <a href="#" class="logo" onclick="showSection('dashboard', document.querySelector('.sidebar-menu a[href=\'#dashboard\']')); return false;"><b>MemeWolf</b>Admin</a>
            <nav class="navbar-custom-menu">
                 <!-- Logout Button REMOVED -->
            </nav>
        </header>

        <aside class="main-sidebar">
            <section class="sidebar">
                <ul class="sidebar-menu">
                    <li class="active"><a href="#dashboard" onclick="showSection('dashboard', this)"><i class="material-icons">dashboard</i> <span>Dashboard</span></a></li>
                    <li><a href="#users" onclick="showSection('users', this)"><i class="material-icons">people</i> <span>User Management</span></a></li>
                    <li><a href="#tasks" onclick="showSection('tasks', this)"><i class="material-icons">checklist</i> <span>Task Management</span></a></li>
                    <li><a href="#luckycodes" onclick="showSection('luckycodes', this)"><i class="material-icons">card_giftcard</i> <span>Lucky Codes</span></a></li>
                    <li><a href="#templates" onclick="showSection('templates', this)"><i class="material-icons">description</i> <span>Message Templates</span></a></li>
                    <li><a href="#autopilot" onclick="showSection('autopilot', this)"><i class="material-icons">schedule</i> <span>Autopilot Config</span></a></li>
                </ul>
            </section>
        </aside>

        <div class="content-wrapper">
            <!-- Section: Dashboard -->
            <section id="dashboard" class="content-section active">
                <div class="content-header"><h1>Dashboard <small>Control panel overview</small></h1></div>
                 <p class="security-warning">
                     <strong>EXTREME SECURITY RISK:</strong> Login has been removed for local use ONLY. This admin panel operates with exposed client-side credentials (Firebase Keys, Bot Token). All actions are performed directly from your browser.
                     <br><strong>DO NOT HOST THIS OR MAKE IT ACCESSIBLE EXTERNALLY.</strong> Implement a secure backend if this needs to be accessed remotely or shared.
                 </p>
                <div class="info-box-container">
                     <div class="info-box"> <span class="info-box-icon bg-aqua"><i class="material-icons">people</i></span> <div class="info-box-content"> <span class="info-box-text">Total Users</span> <span class="info-box-number" id="stat-total-users">...</span> </div> </div>
                     <div class="info-box"> <span class="info-box-icon bg-yellow"><i class="material-icons">account_balance_wallet</i></span> <div class="info-box-content"> <span class="info-box-number" id="stat-total-coins">...</span> <span class="info-box-text">Total Coins (Approx)</span></div> </div>
                     <div class="info-box"> <span class="info-box-icon bg-green"><i class="material-icons">task_alt</i></span> <div class="info-box-content"> <span class="info-box-text">Active Tasks</span> <span class="info-box-number" id="stat-total-tasks">...</span> </div> </div>
                     <div class="info-box"> <span class="info-box-icon bg-red"><i class="material-icons">military_tech</i></span> <div class="info-box-content"> <span class="info-box-number" id="stat-total-rewards">...</span><span class="info-box-text">Total Task Rewards</span> </div> </div>
                     <div class="info-box"> <span class="info-box-icon bg-purple"><i class="material-icons">card_giftcard</i></span> <div class="info-box-content"> <span class="info-box-text">Active Lucky Codes</span> <span class="info-box-number" id="stat-lucky-codes">...</span> </div> </div>
                </div>
            </section>

            <!-- Section: User Management -->
            <section id="users" class="content-section">
                 <div class="content-header"><h1>User Management</h1></div>
                 <div class="box">
                     <div class="box-header"><h3 class="box-title">All Users</h3></div>
                     <div class="box-body">
                        <div id="user-list-status" class="loading-message text-muted">Loading users...</div>
                        <table id="user-table" class="table table-bordered table-striped" style="display:none;">
                            <thead> <tr> <th>User ID</th> <th>Username</th> <th>Name</th> <th>Coins</th> <th>TON Wallet</th> <th>Status</th> <th>Last Update</th> <th>Actions</th> </tr> </thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                 </div>
            </section>

            <!-- Section: Task Management -->
            <section id="tasks" class="content-section">
                 <div class="content-header"><h1>Task Management</h1></div>
                 <div class="box" id="task-form-box" style="display: none;"> <!-- Form Box -->
                     <div class="box-header"><h3 class="box-title" id="task-form-title">Add New Task</h3></div>
                     <form id="task-form">
                         <input type="hidden" id="task-edit-id">
                         <div class="box-body">
                            <div class="form-group"> <label for="task-name">Task Name</label> <input type="text" class="form-control" id="task-name" required> </div>
                            <div class="form-group"> <label for="task-description">Description</label> <textarea class="form-control" id="task-description" rows="3"></textarea> </div>
                            <div class="form-group"> <label for="task-imageUrl">Image URL (Optional)</label> <input type="url" class="form-control" id="task-imageUrl" placeholder="https://..."> </div>
                            <div class="form-group"> <label for="task-reward">Reward (Coins)</label> <input type="number" class="form-control" id="task-reward" required min="0"> </div>
                            <div class="form-group"> <label for="task-link">Task URL / Link</label> <input type="url" class="form-control" id="task-link" placeholder="https://..." required> <small class="text-muted">Required for both types. For 'Code' type, this might be a link to the community where the code is found.</small> </div>
                            <div class="form-group"> <label for="task-type">Task Type</label> <select class="form-control" id="task-type" required> <option value="link">Link Verification (Timed)</option> <option value="code">Code Entry</option> </select> </div>

                            <!-- Link Verification Time (Only for 'link' type) -->
                            <div class="form-group" id="task-verification-time-group" style="display: block;">
                                <label for="task-verification-time">Verification Time (seconds)</label>
                                <input type="number" class="form-control" id="task-verification-time" min="0" value="10">
                                <small class="text-muted">Required for 'Link' type. Time user must spend on the linked page.</small>
                            </div>

                            <!-- Code field (Only for 'code' type) -->
                            <div class="form-group" id="task-code-group" style="display: none;">
                                <label for="task-code">Verification Code</label>
                                <input type="text" class="form-control" id="task-code">
                                <small class="text-muted">Required for 'Code' type. The exact code users need to enter.</small>
                            </div>

                            <div class="form-group">
                                <label for="task-isActive">Active Status</label>
                                <select class="form-control" id="task-isActive" required>
                                    <option value="true">Active (Visible to users)</option>
                                    <option value="false">Inactive (Hidden from users)</option>
                                </select>
                            </div>

                            <div id="task-form-error" class="form-status error-message"></div>
                         </div>
                         <div class="box-footer">
                             <button type="button" class="btn btn-default" onclick="hideTaskForm()">Cancel</button>
                             <button type="submit" class="btn btn-success pull-right">Save Task</button>
                         </div>
                     </form>
                 </div>
                 <div class="box"> <!-- Task List Box -->
                     <div class="box-header">
                        <h3 class="box-title">All Tasks</h3>
                        <div class="box-tools">
                            <button class="btn btn-primary btn-sm" onclick="showAddTaskForm()"> <i class="material-icons">add</i> Add New Task </button>
                        </div>
                    </div>
                     <div class="box-body">
                         <div id="task-list-status" class="loading-message text-muted">Loading tasks...</div>
                         <table id="task-table" class="table table-bordered table-hover" style="display:none;">
                            <thead> <tr> <th>Name</th> <th>Type</th> <th>Status</th> <th>Reward</th> <th>Link</th> <th>Code/Time</th> <th>Actions</th> </tr> </thead>
                            <tbody id="task-table-body"></tbody>
                        </table>
                     </div>
                 </div>
            </section>

            <!-- Section: Lucky Code Management -->
            <section id="luckycodes" class="content-section">
                 <div class="content-header"><h1>Lucky Code Management</h1></div>
                 <div class="box" id="luckycode-form-box" style="display: none;"> <!-- Form Box -->
                     <div class="box-header"><h3 class="box-title" id="luckycode-form-title">Add New Lucky Code</h3></div>
                     <form id="luckycode-form">
                        <input type="hidden" id="luckycode-edit-id">
                        <div class="box-body">
                            <div class="form-group"> <label for="luckycode-code">Code (Case-insensitive, e.g., WOLFMOON42)</label> <input type="text" class="form-control" id="luckycode-code" required style="text-transform: uppercase;"> </div>
                            <div class="form-group"> <label for="luckycode-reward">Reward (Coins)</label> <input type="number" class="form-control" id="luckycode-reward" required min="1"> </div>
                            <div class="form-group"> <label for="luckycode-expiry">Expiry Date & Time (Optional)</label> <input type="datetime-local" class="form-control" id="luckycode-expiry"> <small class="text-muted">Leave blank for no expiry. Bot/server must check validity upon claim.</small> </div>
                            <div id="luckycode-form-error" class="form-status error-message"></div>
                        </div>
                        <div class="box-footer">
                            <button type="button" class="btn btn-default" onclick="hideLuckyCodeForm()">Cancel</button>
                            <button type="submit" class="btn btn-success pull-right">Save Lucky Code</button>
                        </div>
                     </form>
                 </div>
                 <div class="box"> <!-- List Box -->
                     <div class="box-header">
                        <h3 class="box-title">Active & Expired Lucky Codes</h3>
                        <div class="box-tools">
                             <button class="btn btn-primary btn-sm" onclick="showAddLuckyCodeForm()"> <i class="material-icons">add</i> Add Lucky Code </button>
                        </div>
                    </div>
                     <div class="box-body">
                         <div id="luckycode-list-status" class="loading-message text-muted">Loading lucky codes...</div>
                         <table id="luckycode-table" class="table table-bordered table-hover" style="display:none;">
                            <thead> <tr> <th>Code</th> <th>Reward</th> <th>Expiry Date</th> <th>Status</th> <th>Actions</th> </tr> </thead>
                            <tbody id="luckycode-table-body"></tbody>
                        </table>
                     </div>
                 </div>
            </section>

             <!-- Section: Message Templates -->
            <section id="templates" class="content-section">
                 <div class="content-header"><h1>Message Templates</h1></div>
                 <div class="box" id="template-form-box" style="display: none;"> <!-- Form Box -->
                     <div class="box-header"><h3 class="box-title" id="template-form-title">Create/Edit Template</h3></div>
                     <form id="template-form">
                        <input type="hidden" id="template-edit-id">
                        <div class="box-body">
                            <div class="form-group"> <label for="template-name">Template Name (for identification)</label> <input type="text" class="form-control" id="template-name" required> </div>
                            <div class="form-group"> <label for="template-text">Message Text</label> <textarea class="form-control" id="template-text" rows="5"></textarea> <small class="text-muted">Supports basic HTML: &lt;b&gt;, &lt;i&gt;, &lt;a href="..."&gt;, &lt;code&gt;, &lt;pre&gt;</small> </div>
                            <div class="form-group"> <label for="template-image">Image URL (Optional)</label> <input type="url" class="form-control" id="template-image" placeholder="https://..."> </div>
                            <div class="form-group"> <label>Inline Buttons (Optional - Max 5 rows):</label> <div class="inline-button-group" id="template-buttons-container"> <p class="text-muted text-center" style="margin: 5px 0; font-size: 0.9em;" id="template-buttons-placeholder">No buttons added.</p> </div> <button type="button" class="btn btn-default btn-sm" onclick="addTemplateButtonRow()"> <i class="material-icons">add</i> Add Button Row </button> </div>
                            <div id="template-form-error" class="form-status error-message"></div>
                        </div>
                        <div class="box-footer">
                             <button type="button" class="btn btn-default" onclick="hideTemplateForm()">Cancel</button>
                             <button type="submit" class="btn btn-success pull-right">Save Template</button>
                         </div>
                    </form>
                 </div>
                 <div class="box"> <!-- List Box -->
                     <div class="box-header">
                        <h3 class="box-title">Saved Templates</h3>
                        <div class="box-tools">
                            <button class="btn btn-primary btn-sm" onclick="showAddTemplateForm()"> <i class="material-icons">add</i> Create New Template </button>
                        </div>
                    </div>
                     <div class="box-body">
                         <div id="template-list-status" class="loading-message text-muted">Loading templates...</div>
                         <table id="template-table" class="table table-bordered table-hover" style="display:none;">
                            <thead> <tr> <th>Name</th> <th>Preview</th> <th>Actions</th> </tr> </thead>
                            <tbody id="template-table-body"></tbody>
                        </table>
                     </div>
                 </div>
            </section>

             <!-- Section: Autopilot Config -->
             <section id="autopilot" class="content-section">
                 <div class="content-header"><h1>Autopilot Configuration</h1></div>
                 <div class="security-warning"><strong>Important:</strong> This section only SAVES the configuration to Firebase. A separate, secure **SERVER-SIDE SCRIPT** or **BOT LOGIC** is required to READ this config and actually PERFORM the automated actions (scheduling tasks, sending welcome messages). This panel CANNOT run these automations by itself reliably or securely.</div>

                 <!-- Recurring Task Config -->
                 <div class="box">
                     <div class="box-header"><h3 class="box-title">Recurring Daily Task</h3></div>
                     <form id="autopilot-recurring-task-form">
                         <div class="box-body">
                             <p id="autopilot-info">Configure ONE task to be automatically added and/or removed daily. The server/bot must handle the timing (typically around midnight) and check the task's 'isActive' status.</p>
                             <div class="form-group">
                                 <label for="autopilot-task-select">Select Task to Recur:</label>
                                 <select id="autopilot-task-select" class="form-control">
                                     <option value="">-- None (Disable Recurring Task) --</option>
                                     <!-- Options populated by JS -->
                                 </select>
                             </div>
                             <div id="autopilot-task-status" class="form-status"></div>
                         </div>
                         <div class="box-footer">
                            <button type="submit" class="btn btn-primary">Save Recurring Task Setting</button>
                         </div>
                     </form>
                 </div>

                 <!-- Welcome Message Config (REFINED TIMER) -->
                  <div class="box">
                     <div class="box-header"><h3 class="box-title">Automated Welcome Message</h3></div>
                     <form id="autopilot-welcome-message-form">
                         <div class="box-body">
                             <p id="autopilot-info">Configure a message to be sent automatically to new users after a specific delay. Requires server/bot logic.</p>
                             <div class="form-group">
                                 <label for="autopilot-template-select">Select Welcome Message Template:</label>
                                 <select id="autopilot-template-select" class="form-control">
                                      <option value="">-- None (Disable Welcome Message) --</option>
                                      <!-- Options populated by JS -->
                                 </select>
                             </div>
                             <div class="form-group">
                                 <label>Delay after User Joins:</label>
                                 <div class="time-input-group">
                                     <div>
                                         <label for="autopilot-welcome-delay-min">Minutes</label>
                                         <input type="number" id="autopilot-welcome-delay-min" class="form-control" min="0" value="0" required>
                                     </div>
                                      <div>
                                         <label for="autopilot-welcome-delay-sec">Seconds</label>
                                         <input type="number" id="autopilot-welcome-delay-sec" class="form-control" min="0" max="59" value="5" required>
                                      </div>
                                      <div>
                                         <label for="autopilot-welcome-delay-ms">Milliseconds</label>
                                         <input type="number" id="autopilot-welcome-delay-ms" class="form-control" min="0" max="999" value="0" required>
                                      </div>
                                 </div>
                                 <small class="text-muted">Total delay = (Mins * 60000) + (Secs * 1000) + MS. Saved as milliseconds. Server implements the delay.</small>
                             </div>
                             <div id="autopilot-welcome-status" class="form-status"></div>
                         </div>
                          <div class="box-footer">
                             <button type="submit" class="btn btn-primary">Save Welcome Message Setting</button>
                          </div>
                     </form>
                 </div>
             </section>

        </div> <!-- /.content-wrapper -->

         <!-- Modals -->
         <!-- User Edit Modal -->
        <div id="user-edit-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                     <h3 class="modal-title">Edit User: <span id="edit-user-id-display"></span></h3>
                </div>
                <div class="modal-body">
                    <form id="user-edit-form">
                        <input type="hidden" id="edit-user-id">
                        <div class="form-group"> <label>Username:</label> <p><strong id="edit-user-username">N/A</strong></p> </div>
                        <div class="form-group"> <label>Name:</label> <p><strong id="edit-user-fullname">N/A</strong></p> </div>
                        <div class="form-group"> <label for="edit-user-coins">Coins:</label> <input type="number" id="edit-user-coins" class="form-control" required min="0"> </div>
                        <div class="form-group"> <label for="edit-user-tonwallet">TON Wallet:</label> <input type="text" id="edit-user-tonwallet" class="form-control" placeholder="Enter TON wallet address"> </div>
                        <div class="form-group"> <label for="edit-user-banstatus">Ban Status:</label> <select id="edit-user-banstatus" class="form-control"> <option value="false">Active</option> <option value="true">Banned</option> </select> </div>
                        <div id="user-edit-status" class="modal-status"></div>
                    </form>
                </div>
                 <div class="modal-actions">
                    <button type="button" class="btn btn-default modal-button cancel" onclick="hideModal('user-edit-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary modal-button" form="user-edit-form">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Send Message Modal -->
        <div id="send-message-modal" class="modal-overlay">
            <div class="modal-content">
                 <div class="modal-header">
                    <h3 class="modal-title">Send Message to User: <span id="send-message-user-id-display"></span></h3>
                 </div>
                 <div class="modal-body">
                    <p class="security-warning"><strong>CRITICAL SECURITY RISK:</strong> Sending messages via the Bot API directly from the client-side (like this form does) is <strong>EXTREMELY INSECURE</strong> as it exposes your Bot Token in the browser's network requests. <strong>DO NOT USE THIS IN PRODUCTION.</strong> Implement a secure backend endpoint to handle message sending.</p>
                    <form id="send-message-form">
                        <input type="hidden" id="send-message-user-id">
                        <div class="form-group">
                            <label for="send-message-template-select">Use Template (Optional):</label>
                            <select id="send-message-template-select" class="form-control">
                                <option value="">-- Manual Message --</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="send-message-text">Message Text:</label>
                            <textarea id="send-message-text" class="form-control" rows="4" placeholder="Enter message text..."></textarea>
                            <small class="text-muted">Supports basic HTML. Overridden if a template with text is selected.</small>
                        </div>
                        <div class="form-group">
                            <label for="send-message-image">Image URL (Optional):</label>
                            <input type="url" id="send-message-image" class="form-control" placeholder="https://...">
                            <small class="text-muted">Overridden if a template with an image is selected.</small>
                        </div>
                        <div class="form-group">
                            <label>Inline Buttons (Optional - Max 5 rows):</label>
                            <div class="inline-button-group" id="send-message-buttons-container">
                                <p class="text-muted text-center" style="margin: 5px 0; font-size: 0.9em;" id="send-message-buttons-placeholder">No buttons added.</p>
                            </div>
                            <button type="button" class="btn btn-default btn-sm" onclick="addSendMessageButtonRow()">
                                <i class="material-icons">add</i> Add Button Row
                            </button>
                             <small class="text-muted">Overridden if a template with buttons is selected.</small>
                        </div>
                         <div id="send-message-status" class="modal-status"></div>
                    </form>
                 </div>
                 <div class="modal-actions">
                    <button type="button" class="btn btn-default modal-button cancel" onclick="hideModal('send-message-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary modal-button" form="send-message-form">Send Message</button>
                </div>
            </div>
        </div>
        <!-- Flash Message Container (Optional, if you want a dedicated container) -->
        <div id="flash-message-container"></div>

    </div> <!-- /#admin-wrapper -->

    <script>
        // --- Config ---
        // !!! CRITICAL SECURITY WARNING !!!
        // DO NOT USE THESE KEYS IN PRODUCTION CLIENT-SIDE CODE. BUILD A BACKEND.
        const firebaseConfig = {
             apiKey: "AIzaSyCyH3Z92F8RQweInLC5w_bk_AaLx6XT7UE", /* EXPOSED! */
             authDomain: "ab-wallet-62482.firebaseapp.com",
             databaseURL: "https://ab-wallet-62482-default-rtdb.firebaseio.com", /* EXPOSED! */
             projectId: "ab-wallet-62482",
             storageBucket: "ab-wallet-62482.firebasestorage.app",
             messagingSenderId: "642030839072",
             appId: "1:642030839072:web:77fc92375ba72e2ee62345"
         };
        // const ADMIN_PASSWORD = "asrabu123"; // <<< REMOVED - NO LOGIN
        const BOT_TOKEN = "7247227786:AAFPgf5XFARQ3uzz11rVAgZyw2vpHTV7k34"; // <<< NEVER expose this client-side in production!

        // --- Firebase Vars ---
        let db = null;

        // --- DOM Elements ---
        // Login elements REMOVED
        const adminWrapper = document.getElementById('admin-wrapper');
        // Logout button element REMOVED
        const contentSections = document.querySelectorAll('.content-section');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu li');
        // Dashboard Stats
        const statTotalUsers = document.getElementById('stat-total-users');
        const statTotalCoins = document.getElementById('stat-total-coins');
        const statTotalTasks = document.getElementById('stat-total-tasks');
        const statTotalRewards = document.getElementById('stat-total-rewards');
        const statLuckyCodes = document.getElementById('stat-lucky-codes');
        // User Management
        const userTable = document.getElementById('user-table');
        const userTableBody = document.getElementById('user-table-body');
        const userListStatus = document.getElementById('user-list-status');
        // Task Management
        const taskTable = document.getElementById('task-table');
        const taskTableBody = document.getElementById('task-table-body');
        const taskListStatus = document.getElementById('task-list-status');
        const taskFormBox = document.getElementById('task-form-box');
        const taskFormTitle = document.getElementById('task-form-title');
        const taskForm = document.getElementById('task-form');
        const taskEditIdInput = document.getElementById('task-edit-id');
        const taskNameInput = document.getElementById('task-name');
        const taskDescriptionInput = document.getElementById('task-description');
        const taskImageUrlInput = document.getElementById('task-imageUrl');
        const taskRewardInput = document.getElementById('task-reward');
        const taskLinkInput = document.getElementById('task-link');
        const taskTypeSelect = document.getElementById('task-type');
        const taskCodeGroup = document.getElementById('task-code-group');
        const taskCodeInput = document.getElementById('task-code');
        const taskVerificationTimeGroup = document.getElementById('task-verification-time-group');
        const taskVerificationTimeInput = document.getElementById('task-verification-time');
        const taskIsActiveSelect = document.getElementById('task-isActive');
        const taskFormError = document.getElementById('task-form-error');
        // Lucky Codes
        const luckyCodeTable = document.getElementById('luckycode-table');
        const luckyCodeTableBody = document.getElementById('luckycode-table-body');
        const luckyCodeListStatus = document.getElementById('luckycode-list-status');
        const luckyCodeFormBox = document.getElementById('luckycode-form-box');
        const luckyCodeFormTitle = document.getElementById('luckycode-form-title');
        const luckyCodeForm = document.getElementById('luckycode-form');
        const luckyCodeEditIdInput = document.getElementById('luckycode-edit-id');
        const luckyCodeCodeInput = document.getElementById('luckycode-code');
        const luckyCodeRewardInput = document.getElementById('luckycode-reward');
        const luckyCodeExpiryInput = document.getElementById('luckycode-expiry');
        const luckyCodeFormError = document.getElementById('luckycode-form-error');
        // Message Templates
        const templateTable = document.getElementById('template-table');
        const templateTableBody = document.getElementById('template-table-body');
        const templateListStatus = document.getElementById('template-list-status');
        const templateFormBox = document.getElementById('template-form-box');
        const templateFormTitle = document.getElementById('template-form-title');
        const templateForm = document.getElementById('template-form');
        const templateEditIdInput = document.getElementById('template-edit-id');
        const templateNameInput = document.getElementById('template-name');
        const templateTextInput = document.getElementById('template-text');
        const templateImageInput = document.getElementById('template-image');
        const templateButtonsContainer = document.getElementById('template-buttons-container');
        const templateButtonsPlaceholder = document.getElementById('template-buttons-placeholder');
        const templateFormError = document.getElementById('template-form-error');
        // Autopilot
        const autopilotRecurringTaskForm = document.getElementById('autopilot-recurring-task-form');
        const autopilotTaskSelect = document.getElementById('autopilot-task-select');
        const autopilotTaskStatus = document.getElementById('autopilot-task-status');
        const autopilotWelcomeMessageForm = document.getElementById('autopilot-welcome-message-form');
        const autopilotTemplateSelect = document.getElementById('autopilot-template-select');
        const autopilotWelcomeDelayMinInput = document.getElementById('autopilot-welcome-delay-min');
        const autopilotWelcomeDelaySecInput = document.getElementById('autopilot-welcome-delay-sec');
        const autopilotWelcomeDelayMsInput = document.getElementById('autopilot-welcome-delay-ms');
        const autopilotWelcomeStatus = document.getElementById('autopilot-welcome-status');
        // Modals
        const userEditModal = document.getElementById('user-edit-modal');
        const userEditForm = document.getElementById('user-edit-form');
        const editUserIdInput = document.getElementById('edit-user-id');
        const editUserIdDisplay = document.getElementById('edit-user-id-display');
        const editUserUsername = document.getElementById('edit-user-username');
        const editUserFullname = document.getElementById('edit-user-fullname');
        const editUserCoinsInput = document.getElementById('edit-user-coins');
        const editUserTonWalletInput = document.getElementById('edit-user-tonwallet');
        const editUserBanStatusSelect = document.getElementById('edit-user-banstatus');
        const userEditStatus = document.getElementById('user-edit-status');
        // Send Message Modal
        const sendMessageModal = document.getElementById('send-message-modal');
        const sendMessageForm = document.getElementById('send-message-form');
        const sendMessageUserIdInput = document.getElementById('send-message-user-id');
        const sendMessageUserIdDisplay = document.getElementById('send-message-user-id-display');
        const sendMessageTemplateSelect = document.getElementById('send-message-template-select');
        const sendMessageTextInput = document.getElementById('send-message-text');
        const sendMessageImageInput = document.getElementById('send-message-image');
        const sendMessageButtonsContainer = document.getElementById('send-message-buttons-container');
        const sendMessageButtonsPlaceholder = document.getElementById('send-message-buttons-placeholder');
        const sendMessageStatus = document.getElementById('send-message-status');


        // --- Cache ---
        let adminTasksCache = {};
        let adminUsersCache = {};
        let adminLuckyCodesCache = {};
        let adminTemplatesCache = {};
        let adminAutopilotConfigCache = {};

        // --- Initialization ---
        window.onload = () => {
            // Directly initialize panel on load
            initializeFirebaseAndPanel();
            console.log("Admin Panel Initializing (No Login)...");
        };

        function initializeFirebaseAndPanel() {
            if (db) { // Already initialized
                showAdminPanel(); // Make sure panel loads data if already init
                return;
            }

            try {
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.database();
                console.log("Firebase Initialized Successfully.");

                setupAdminEventListeners();
                showAdminPanel(); // Show panel and load initial data
                console.log("Admin Panel Initialized.");

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // Display error message prominently if Firebase fails
                const wrapper = document.getElementById('admin-wrapper');
                if(wrapper) {
                    wrapper.innerHTML = `<div style="padding: 30px; text-align: center; color: var(--box-red);">
                        <h2>CRITICAL ERROR</h2>
                        <p>Could not connect to Firebase database.</p>
                        <p>Check your internet connection and the Firebase configuration in the script.</p>
                        <p>Error: ${escapeHtml(error.message)}</p>
                        </div>`;
                }
            }
        }

        // --- Login / Session --- REMOVED ---
        // checkLoginState(), handleLogin(), handleLogout(), showLogin() functions deleted.

        function showAdminPanel() {
            // No login check needed, just ensure DB connection before loading data
            if (!db) {
                console.error("Attempted to show admin panel without DB connection.");
                // Error is already shown by initializeFirebaseAndPanel failure
                return;
            }
            // Admin wrapper is already visible via CSS
            loadDashboardStats(); // Load stats immediately
            // Navigate to the default section (Dashboard)
            const dashboardLink = document.querySelector('.sidebar-menu a[href="#dashboard"]');
            showSection('dashboard', dashboardLink);
        }

        // --- Navigation ---
        function showSection(sectionId, clickedLinkElement) {
             // No login check needed
            if (!db) return; // Don't navigate if DB failed

            console.log(`Navigating to section: ${sectionId}`);
            contentSections.forEach(section => section.classList.remove('active'));
            const targetSection = document.getElementById(sectionId);

            if (targetSection) {
                targetSection.classList.add('active');
            } else {
                console.warn(`Section with ID "${sectionId}" not found. Falling back to dashboard.`);
                document.getElementById('dashboard')?.classList.add('active');
                sectionId = 'dashboard';
            }

            sidebarLinks.forEach(li => li.classList.remove('active'));
            if (clickedLinkElement?.closest('li')) {
                clickedLinkElement.closest('li').classList.add('active');
            } else {
                 // Fallback if called without a link element
                document.querySelector(`.sidebar-menu a[href="#${sectionId}"]`)?.closest('li')?.classList.add('active');
            }

            // Load data for the activated section
            const loadFunctions = {
                'dashboard': loadDashboardStats,
                'users': loadUsers,
                'tasks': loadAdminTasks,
                'luckycodes': loadLuckyCodes,
                'templates': loadTemplates,
                'autopilot': loadAutopilotConfig
            };
            if (loadFunctions[sectionId]) {
                loadFunctions[sectionId]();
            } else {
                console.warn(`No load function defined for section: ${sectionId}`);
            }

            // Hide any open forms when switching sections
            hideTaskForm();
            hideLuckyCodeForm();
            hideTemplateForm();
        }

        // --- Dashboard ---
        // loadDashboardStats() function remains the same as the previous version

        // --- User Management ---
        // loadUsers(), renderUserRow(), handleBanUser(), handleUnbanUser(), handleDeleteUser() functions remain the same

        // --- User Edit Modal Logic ---
        // showEditUserForm(), handleUserEditSubmit() functions remain the same

        // --- Send Message Modal Logic ---
        // showSendMessageForm(), sendMessageTemplateSelect event listener, addSendMessageButtonRow(), removeButtonRow(), handleSendMessageSubmit() functions remain the same

        // --- Task Management ---
        // loadAdminTasks(), renderAdminTaskRow(), showAddTaskForm(), showEditTaskForm(), hideTaskForm(), toggleTaskFieldsVisibility(), handleTaskFormSubmit(), handleDeleteTask(), cacheAdminTasks() functions remain the same

        // --- Lucky Code Management ---
        // loadLuckyCodes(), renderLuckyCodeRow(), showAddLuckyCodeForm(), showEditLuckyCodeForm(), hideLuckyCodeForm(), handleLuckyCodeFormSubmit(), handleDeleteLuckyCode() functions remain the same

        // --- Message Templates Management ---
        // loadTemplates(), renderTemplateRow(), showAddTemplateForm(), showEditTemplateForm(), hideTemplateForm(), addTemplateButtonRow(), handleTemplateFormSubmit(), handleDeleteTemplate() functions remain the same

        // --- Autopilot Configuration ---
        // loadAutopilotConfig(), handleSaveRecurringTask(), handleSaveWelcomeMessage() functions remain the same

        // --- Utility Functions ---
        // formatAdminNumber(), escapeHtml(), showModal(), hideModal(), setStatusMessage(), populateDropdown(), populateTaskDropdown(), populateTemplateDropdown(), renderEmptyRow(), showFlashMessage() functions remain the same
        // triggerShakeAnimation() can be removed as it was only used for login error.

        // --- Event Listeners ---
        function setupAdminEventListeners() {
             // Login/Logout listeners REMOVED
             taskForm.addEventListener('submit', handleTaskFormSubmit);
             taskTypeSelect.addEventListener('change', toggleTaskFieldsVisibility); // Use helper function
             luckyCodeForm.addEventListener('submit', handleLuckyCodeFormSubmit);
             templateForm.addEventListener('submit', handleTemplateFormSubmit);
             autopilotRecurringTaskForm.addEventListener('submit', handleSaveRecurringTask);
             autopilotWelcomeMessageForm.addEventListener('submit', handleSaveWelcomeMessage);
             userEditForm.addEventListener('submit', handleUserEditSubmit);
             sendMessageForm.addEventListener('submit', handleSendMessageSubmit);
            // Modal close listeners remain the same
            document.querySelectorAll('.modal-overlay').forEach(modal => { modal.addEventListener('click', (event) => { if (event.target === modal) hideModal(modal.id); }); });
            document.querySelectorAll('.modal-button.cancel').forEach(btn => { btn.addEventListener('click', (e) => { const modal = e.target.closest('.modal-overlay'); if (modal) hideModal(modal.id); }); });
            console.log("Admin Event Listeners Setup (No Login).");
        }

        // Shake animation style REMOVED (or can be kept if needed elsewhere)

        // --- All other functions (Dashboard, User, Task, Code, Template, Autopilot, Modals, Utilities) remain the same as the previous version ---
        // Ensure you copy them over from the previous code block I provided.
        // I've omitted repeating them here for brevity, but they are necessary.

        // Re-include the actual implementation of all the data loading/rendering/handling functions here...
        // (loadDashboardStats, loadUsers, renderUserRow, showEditUserForm, handleUserEditSubmit, etc...)
        // ... COPY ALL FUNCTIONS FROM THE PREVIOUS VERSION HERE ...
        // (Except the deleted login-related ones: checkLoginState, handleLogin, handleLogout, showLogin, triggerShakeAnimation)

        // --- Dashboard ---
        function loadDashboardStats() {
            if (!db) return;
            console.log("Loading dashboard stats...");
            statTotalUsers.textContent = '...'; statTotalCoins.textContent = '...';
            statTotalTasks.textContent = '...'; statTotalRewards.textContent = '...';
            statLuckyCodes.textContent = '...';

            const refs = {
                users: db.ref('users'),
                tasks: db.ref('tasks'),
                luckyCodes: db.ref('luckyCodes')
            };
            const now = Date.now();

            Promise.all([refs.users.once('value'), refs.tasks.once('value'), refs.luckyCodes.once('value')])
            .then(([usersSnapshot, tasksSnapshot, luckyCodesSnapshot]) => {
                let stats = { users: 0, coins: 0, tasks: 0, rewards: 0, codes: 0 };

                if (usersSnapshot.exists()) {
                    const usersData = usersSnapshot.val();
                    stats.users = Object.keys(usersData).length;
                    stats.coins = Object.values(usersData).reduce((sum, user) => sum + (user?.coins || 0), 0);
                }
                if (tasksSnapshot.exists()) {
                    const tasksData = tasksSnapshot.val();
                    // Count only *active* tasks for the dashboard stat
                    stats.tasks = Object.values(tasksData).filter(task => task?.isActive === true).length;
                    stats.rewards = Object.values(tasksData).reduce((sum, task) => sum + (task?.reward || 0), 0); // Total reward of ALL tasks
                }
                if (luckyCodesSnapshot.exists()) {
                    stats.codes = Object.values(luckyCodesSnapshot.val()).filter(code => !code.expiryTimestamp || code.expiryTimestamp > now).length;
                }

                statTotalUsers.textContent = formatAdminNumber(stats.users);
                statTotalCoins.textContent = formatAdminNumber(stats.coins);
                statTotalTasks.textContent = formatAdminNumber(stats.tasks); // Show active tasks count
                statTotalRewards.textContent = formatAdminNumber(stats.rewards);
                statLuckyCodes.textContent = formatAdminNumber(stats.codes);
            })
            .catch(error => {
                console.error("Error loading dashboard stats:", error);
                [statTotalUsers, statTotalCoins, statTotalTasks, statTotalRewards, statLuckyCodes].forEach(el => el.textContent = 'Error');
                showFlashMessage("Error loading dashboard stats.", "error");
            });
        }

        // --- User Management ---
        function loadUsers() {
            if (!db) return;
            console.log("Loading users...");
            setStatusMessage(userListStatus, 'Loading users...', false, false, true);
            userTable.style.display = 'none';
            userTableBody.innerHTML = '';
            adminUsersCache = {};

            db.ref('users').orderByChild('lastUpdate').limitToLast(200).once('value')
            .then(snapshot => {
                adminUsersCache = snapshot.val() || {};
                const userIds = Object.keys(adminUsersCache).sort((a, b) => (adminUsersCache[b].lastUpdate || 0) - (adminUsersCache[a].lastUpdate || 0)); // Sort newest first
                let userCount = userIds.length;

                if (userCount > 0) {
                    userIds.forEach(userId => renderUserRow(userId, adminUsersCache[userId]));
                    userTable.style.display = 'table';
                    setStatusMessage(userListStatus, userCount >= 200 ? 'Showing latest 200 users.' : '', false);
                } else {
                    renderEmptyRow(userTableBody, 8, "No users found."); // Colspan is now 8
                    userTable.style.display = 'table';
                    setStatusMessage(userListStatus, '', false);
                }
            })
            .catch(error => {
                console.error("Error loading users:", error);
                setStatusMessage(userListStatus, 'Error loading users. Check console.', true);
                userTable.style.display = 'none';
                showFlashMessage("Failed to load users.", "error");
            });
        }

        function renderUserRow(userId, userData) {
            const isBanned = userData?.isBanned === true;
            const row = userTableBody.insertRow();
            row.dataset.userId = userId;

            let lastUpdateText = '<span class="text-muted">N/A</span>';
            if (userData?.lastUpdate) {
                try {
                    lastUpdateText = new Date(userData.lastUpdate).toLocaleString();
                } catch (e) { /* Ignore formatting error */ }
            }

            row.innerHTML = `
                <td>${userId}</td>
                <td>${userData.telegramInfo?.username ? ('@' + escapeHtml(userData.telegramInfo.username)) : '<span class="text-muted">N/A</span>'}</td>
                <td>${escapeHtml(userData.telegramInfo?.firstName || '')} ${escapeHtml(userData.telegramInfo?.lastName || '') || '<span class="text-muted">No Name</span>'}</td>
                <td>${formatAdminNumber(userData.coins || 0)}</td>
                <td>${escapeHtml(userData.tonWallet) || '<span class="text-muted">Not Set</span>'}</td>
                <td><span class="status-indicator ${isBanned ? 'status-banned' : 'status-active'}"></span>${isBanned ? 'Banned' : 'Active'}</td>
                <td><small>${lastUpdateText}</small></td>
                <td class="table-actions">
                    <button class="btn btn-warning btn-xs" onclick="showEditUserForm('${userId}')" title="Edit User"><i class="material-icons">edit</i></button>
                    <button class="btn btn-primary btn-xs" onclick="showSendMessageForm('${userId}')" title="Send Message"><i class="material-icons">message</i></button>
                    ${isBanned ? `<button class="btn btn-success btn-xs" onclick="handleUnbanUser('${userId}')" title="Unban User"><i class="material-icons">lock_open</i></button>` : `<button class="btn btn-danger btn-xs" onclick="handleBanUser('${userId}')" title="Ban User"><i class="material-icons">block</i></button>`}
                    <button class="btn btn-danger btn-xs" onclick="handleDeleteUser('${userId}')" title="DELETE User (Permanent!)"><i class="material-icons">delete_forever</i></button>
                </td>
            `;
        }
        function handleBanUser(userId) { if (!confirm(`Are you sure you want to BAN user ${userId}?`)) return; if (!db) return; db.ref(`users/${userId}/isBanned`).set(true).then(() => { console.log(`User ${userId} banned.`); loadUsers(); showFlashMessage(`User ${userId} banned successfully.`, 'success'); }).catch(error => { console.error("Ban error:", error); showFlashMessage(`Failed to ban user: ${error.message}`, "error"); }); }
        function handleUnbanUser(userId) { if (!confirm(`Are you sure you want to UNBAN user ${userId}?`)) return; if (!db) return; db.ref(`users/${userId}/isBanned`).set(null).then(() => { console.log(`User ${userId} unbanned.`); loadUsers(); showFlashMessage(`User ${userId} unbanned successfully.`, 'success'); }).catch(error => { console.error("Unban error:", error); showFlashMessage(`Failed to unban user: ${error.message}`, "error"); }); }
        function handleDeleteUser(userId) { if (!confirm(`DELETE USER ${userId}?\n\nThis action is PERMANENT and cannot be undone!`)) return; if (!confirm(`FINAL WARNING: Really delete user ${userId} and all their data? There is no going back!`)) return; if (!db) return; db.ref(`users/${userId}`).remove().then(() => { console.log(`User ${userId} DELETED.`); delete adminUsersCache[userId]; loadUsers(); showFlashMessage(`User ${userId} permanently deleted.`, 'success'); }).catch(error => { console.error("Delete user error:", error); showFlashMessage(`Failed to delete user ${userId}. Error: ${error.message}`, "error"); }); }

        // --- User Edit Modal Logic ---
        function showEditUserForm(userId) { const userData = adminUsersCache[userId]; if (!userData) { showFlashMessage("User data not found in cache. Please refresh user list.", "error"); return; } editUserIdInput.value = userId; editUserIdDisplay.textContent = userId; editUserUsername.textContent = userData.telegramInfo?.username ? '@' + escapeHtml(userData.telegramInfo.username) : 'N/A'; editUserFullname.textContent = `${escapeHtml(userData.telegramInfo?.firstName || '')} ${escapeHtml(userData.telegramInfo?.lastName || '')}`.trim() || 'N/A'; editUserCoinsInput.value = userData.coins || 0; editUserTonWalletInput.value = userData.tonWallet || ''; editUserBanStatusSelect.value = userData.isBanned === true ? 'true' : 'false'; setStatusMessage(userEditStatus, '', false); showModal('user-edit-modal'); }
        function handleUserEditSubmit(event) {
            event.preventDefault();
            if (!db) return;
            const userId = editUserIdInput.value;
            if (!userId) { setStatusMessage(userEditStatus, 'Error: User ID missing.', true); return; }
            const coins = parseInt(editUserCoinsInput.value);
            if (isNaN(coins) || coins < 0) { setStatusMessage(userEditStatus, 'Invalid coin amount. Must be a non-negative number.', true); editUserCoinsInput.focus(); return; }
            const tonWallet = editUserTonWalletInput.value.trim();
            const updates = {
                coins: coins,
                tonWallet: tonWallet || null,
                isBanned: editUserBanStatusSelect.value === 'true' ? true : null,
                lastUpdate: firebase.database.ServerValue.TIMESTAMP // Update timestamp on edit
            };
            setStatusMessage(userEditStatus, 'Saving...', false, false, true);
            db.ref(`users/${userId}`).update(updates).then(() => {
                setStatusMessage(userEditStatus, 'User updated successfully!', false, true);
                if(adminUsersCache[userId]) {
                    adminUsersCache[userId] = { ...adminUsersCache[userId], ...updates };
                    if (updates.isBanned === null) delete adminUsersCache[userId].isBanned;
                    adminUsersCache[userId].lastUpdate = Date.now();
                }
                loadUsers();
                setTimeout(() => hideModal('user-edit-modal'), 1500);
            }).catch(error => {
                console.error("Error updating user:", error);
                setStatusMessage(userEditStatus, `Save Error: ${error.message}`, true);
            });
        }

        // --- Send Message Modal Logic ---
        function showSendMessageForm(userId) { if (!adminTemplatesCache || Object.keys(adminTemplatesCache).length === 0) loadTemplates(true); else populateTemplateDropdown(sendMessageTemplateSelect, adminTemplatesCache, '-- Manual Message --'); sendMessageUserIdInput.value = userId; sendMessageUserIdDisplay.textContent = userId; sendMessageTemplateSelect.value = ""; sendMessageForm.reset(); sendMessageButtonsContainer.innerHTML = ''; sendMessageButtonsPlaceholder.style.display = 'block'; sendMessageUserIdInput.value = userId; sendMessageUserIdDisplay.textContent = userId; setStatusMessage(sendMessageStatus, '', false); showModal('send-message-modal'); }
        sendMessageTemplateSelect?.addEventListener('change', (event) => { const templateId = event.target.value; const templateData = adminTemplatesCache[templateId]; sendMessageForm.reset(); sendMessageButtonsContainer.innerHTML = ''; sendMessageButtonsPlaceholder.style.display = 'block'; if (templateData) { sendMessageTextInput.value = templateData.text || ''; sendMessageImageInput.value = templateData.image || ''; if (templateData.buttons && Array.isArray(templateData.buttons)) { sendMessageButtonsPlaceholder.style.display = 'none'; templateData.buttons.forEach((buttonRow) => { if (Array.isArray(buttonRow) && buttonRow.length > 0) addSendMessageButtonRow(buttonRow[0].text, buttonRow[0].url); }); } } sendMessageUserIdInput.value = sendMessageModal.querySelector('#send-message-user-id-display').textContent; });
        function addSendMessageButtonRow(labelText = '', urlText = '') { if (sendMessageButtonsContainer.children.length >= 5) { showFlashMessage("Maximum of 5 button rows allowed.", "warning"); return; } sendMessageButtonsPlaceholder.style.display = 'none'; const div = document.createElement('div'); div.className = 'inline-button-row'; div.innerHTML = ` <input type="text" class="form-control message-button-label" placeholder="Button Label" value="${escapeHtml(labelText)}" required> <input type="url" class="form-control message-button-url" placeholder="Button URL (https://...)" value="${escapeHtml(urlText)}" required> <button type="button" class="btn btn-danger btn-xs" onclick="removeButtonRow(this, 'send-message-buttons-placeholder')" title="Remove Row"><i class="material-icons">remove_circle_outline</i></button> `; sendMessageButtonsContainer.appendChild(div); }
        function removeButtonRow(buttonElement, placeholderId) { const row = buttonElement.closest('.inline-button-row'); const container = row.parentElement; row.remove(); if (container.children.length === 0) { const placeholder = document.getElementById(placeholderId); if (placeholder) placeholder.style.display = 'block'; } }
        async function handleSendMessageSubmit(event) { event.preventDefault(); if (!BOT_TOKEN) { setStatusMessage(sendMessageStatus, 'CRITICAL: Bot Token is missing or empty. Cannot send.', true); console.error("CRITICAL SECURITY RISK: BOT_TOKEN is missing or empty!"); return; } if (!db) { setStatusMessage(sendMessageStatus, 'Error: Database connection lost.', true); return; } const chatId = sendMessageUserIdInput.value; const templateId = sendMessageTemplateSelect.value; let text = sendMessageTextInput.value.trim(); let imageUrl = sendMessageImageInput.value.trim(); let buttons = []; let buttonsValid = true; const buttonRows = sendMessageButtonsContainer.querySelectorAll('.inline-button-row'); buttonRows.forEach(row => { const labelInput = row.querySelector('.message-button-label'); const urlInput = row.querySelector('.message-button-url'); const label = labelInput?.value.trim(); const url = urlInput?.value.trim(); if (label && url) { try { new URL(url); buttons.push([{ text: label, url: url }]); } catch (_) { buttonsValid = false; urlInput?.focus(); } } else if (label || url) { buttonsValid = false; if (!label) labelInput?.focus(); else urlInput?.focus(); } }); if (!buttonsValid) { setStatusMessage(sendMessageStatus, 'Error: Incomplete or invalid button label/URL.', true); return; } if (templateId && adminTemplatesCache[templateId]) { const templateData = adminTemplatesCache[templateId]; text = templateData.text || ''; imageUrl = templateData.image || ''; buttons = templateData.buttons || []; } if (!chatId || (!text && !imageUrl)) { setStatusMessage(sendMessageStatus, 'Error: User ID and Message Text or Image URL required.', true); return; } setStatusMessage(sendMessageStatus, 'Sending (INSECURE CLIENT-SIDE)...', false, false, true); try { const payload = { chat_id: chatId, parse_mode: 'HTML', disable_web_page_preview: false }; let apiUrl = `https://api.telegram.org/bot${BOT_TOKEN}/`; let method = ''; if (imageUrl) { method = 'sendPhoto'; payload.photo = imageUrl; if (text) payload.caption = text; } else if (text) { method = 'sendMessage'; payload.text = text; } else { throw new Error("No text or image provided."); } apiUrl += method; if (buttons && buttons.length > 0) payload.reply_markup = JSON.stringify({ inline_keyboard: buttons }); const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const result = await response.json(); if (!response.ok || !result.ok) throw new Error(result.description || `Telegram API Error: ${response.status}`); console.log("Message sent (INSECURELY):", result); setStatusMessage(sendMessageStatus, 'Message sent successfully!', false, true); setTimeout(() => hideModal('send-message-modal'), 1500); } catch (error) { console.error("Error sending Telegram message (INSECURE):", error); setStatusMessage(sendMessageStatus, `Send Error: ${error.message}`, true); } }

        // --- Task Management ---
        function loadAdminTasks(isDependency = false) {
            if (!db) return;
            if (!isDependency) {
                console.log("Loading admin tasks...");
                setStatusMessage(taskListStatus, 'Loading tasks...', false, false, true);
                taskTable.style.display = 'none';
                taskTableBody.innerHTML = '';
            }
            db.ref('tasks').orderByChild('name').once('value').then(snapshot => {
                cacheAdminTasks(snapshot.val());
                if (!isDependency) {
                    const tasksData = adminTasksCache;
                    let count = 0;
                    if (tasksData && Object.keys(tasksData).length > 0) {
                        Object.keys(tasksData).forEach(taskId => { // Already sorted by name from query
                            renderAdminTaskRow(taskId, tasksData[taskId]); count++;
                        });
                        taskTable.style.display = 'table'; setStatusMessage(taskListStatus, '', false);
                    } else {
                        renderEmptyRow(taskTableBody, 7, "No tasks found. Add one using the button above."); // Colspan now 7
                        taskTable.style.display = 'table'; setStatusMessage(taskListStatus, '', false);
                    }
                }
                if (isDependency || document.getElementById('autopilot')?.classList.contains('active')) {
                    populateTaskDropdown(autopilotTaskSelect, adminTasksCache, '-- None (Disable Recurring Task) --');
                    if (adminAutopilotConfigCache?.recurringTask?.taskId) autopilotTaskSelect.value = adminAutopilotConfigCache.recurringTask.taskId;
                }
                loadDashboardStats();
            }).catch(error => {
                console.error("Error loading admin tasks:", error);
                cacheAdminTasks({});
                if (!isDependency) {
                    setStatusMessage(taskListStatus, 'Error loading tasks. Check console.', true);
                    renderEmptyRow(taskTableBody, 7, "Error loading tasks.");
                    taskTable.style.display = 'table';
                }
            });
        }

        function renderAdminTaskRow(taskId, taskData) {
            const row = taskTableBody.insertRow();
            row.dataset.taskId = taskId;
            const isActive = taskData?.isActive === true;
            const type = taskData?.type || 'link';

            const linkDisplay = taskData.link ? `<a href="${escapeHtml(taskData.link)}" target="_blank" title="${escapeHtml(taskData.link)}">${escapeHtml(taskData.link).substring(0, 30)}...</a>` : '<span class="text-muted">N/A</span>';

            let codeOrTimeDisplay = '<span class="text-muted">N/A</span>';
            if (type === 'code' && taskData.code) {
                codeOrTimeDisplay = `<code>${escapeHtml(taskData.code)}</code>`;
            } else if (type === 'link' && typeof taskData.verificationTime === 'number') {
                codeOrTimeDisplay = `${taskData.verificationTime} sec`;
            }

            row.innerHTML = `
                <td>
                    <img src="${escapeHtml(taskData.imageUrl) || 'https://via.placeholder.com/30x30?text=N/A'}" alt="Icon">
                    <span class="text-bold">${escapeHtml(taskData.name || 'Untitled Task')}</span>
                    ${taskData.description ? `<br><small class="text-muted">${escapeHtml(taskData.description)}</small>` : ''}
                </td>
                <td><span class="label bg-${type === 'code' ? 'purple' : 'blue'}">${escapeHtml(type)}</span></td>
                <td><span class="status-indicator ${isActive ? 'status-active' : 'status-inactive'}"></span>${isActive ? 'Active' : 'Inactive'}</td>
                <td>${formatAdminNumber(taskData.reward || 0)} <i class="material-icons" style="font-size:1em; color:var(--box-yellow); vertical-align:middle;">monetization_on</i></td>
                <td>${linkDisplay}</td>
                <td>${codeOrTimeDisplay}</td>
                <td class="table-actions">
                    <button class="btn btn-warning btn-xs" onclick="showEditTaskForm('${taskId}')" title="Edit Task"><i class="material-icons">edit</i></button>
                    <button class="btn btn-danger btn-xs" onclick="handleDeleteTask('${taskId}')" title="Delete Task"><i class="material-icons">delete</i></button>
                </td>
            `;
        }

        function showAddTaskForm() { taskFormBox.style.display = 'block'; taskFormTitle.textContent = 'Add New Task'; taskForm.reset(); taskEditIdInput.value = ''; taskIsActiveSelect.value = 'true'; taskTypeSelect.value = 'link'; toggleTaskFieldsVisibility(); setStatusMessage(taskFormError, '', false); taskFormBox.scrollIntoView({ behavior: 'smooth', block: 'start' }); taskNameInput.focus(); }
        function showEditTaskForm(taskId) { const taskData = adminTasksCache[taskId]; if (!taskData) { showFlashMessage("Task data not found. Please refresh.", "error"); return; } taskFormBox.style.display = 'block'; taskFormTitle.textContent = 'Edit Task'; taskForm.reset(); taskEditIdInput.value = taskId; taskNameInput.value = taskData.name || ''; taskDescriptionInput.value = taskData.description || ''; taskImageUrlInput.value = taskData.imageUrl || ''; taskRewardInput.value = taskData.reward || 0; taskLinkInput.value = taskData.link || ''; taskTypeSelect.value = taskData.type || 'link'; taskCodeInput.value = taskData.code || ''; taskVerificationTimeInput.value = typeof taskData.verificationTime === 'number' ? taskData.verificationTime : 10; taskIsActiveSelect.value = taskData.isActive === true ? 'true' : 'false'; setStatusMessage(taskFormError, '', false); toggleTaskFieldsVisibility(); taskFormBox.scrollIntoView({ behavior: 'smooth', block: 'start' }); taskNameInput.focus(); }
        function hideTaskForm() { taskFormBox.style.display = 'none'; taskForm.reset(); taskEditIdInput.value = ''; setStatusMessage(taskFormError, '', false); }

        function toggleTaskFieldsVisibility() {
             const type = taskTypeSelect.value;
             taskCodeGroup.style.display = (type === 'code') ? 'block' : 'none';
             taskVerificationTimeGroup.style.display = (type === 'link') ? 'block' : 'none';
        }

        function handleTaskFormSubmit(event) {
            event.preventDefault();
            if (!db) return;
            setStatusMessage(taskFormError, '', false);

            const taskId = taskEditIdInput.value;
            const name = taskNameInput.value.trim();
            const reward = parseInt(taskRewardInput.value);
            const type = taskTypeSelect.value;
            const code = taskCodeInput.value.trim();
            const verificationTime = parseInt(taskVerificationTimeInput.value);
            const isActive = taskIsActiveSelect.value === 'true';
            const link = taskLinkInput.value.trim();
            const imageUrl = taskImageUrlInput.value.trim();

            // Validation
            if (!name) { setStatusMessage(taskFormError, "Task Name is required.", true); taskNameInput.focus(); return; }
            if (isNaN(reward) || reward < 0) { setStatusMessage(taskFormError, "Reward must be a non-negative number.", true); taskRewardInput.focus(); return; }
            if (!link) { setStatusMessage(taskFormError, "Task URL / Link is required.", true); taskLinkInput.focus(); return; }
            try { new URL(link); } catch (_) { setStatusMessage(taskFormError, "Task URL / Link is invalid.", true); taskLinkInput.focus(); return; }
            if (type === 'code' && !code) { setStatusMessage(taskFormError, "Verification Code is required for Code type tasks.", true); taskCodeInput.focus(); return; }
            if (type === 'link' && (isNaN(verificationTime) || verificationTime < 0)) { setStatusMessage(taskFormError, "Verification Time must be a non-negative number for Link tasks.", true); taskVerificationTimeInput.focus(); return; }
            try { if (imageUrl) new URL(imageUrl); } catch (_) { setStatusMessage(taskFormError, "Image URL is invalid.", true); taskImageUrlInput.focus(); return; }

            const taskData = {
                name: name,
                description: taskDescriptionInput.value.trim() || null,
                imageUrl: imageUrl || null,
                reward: reward,
                link: link,
                type: type,
                isActive: isActive,
                code: (type === 'code' && code) ? code : null,
                verificationTime: (type === 'link' && !isNaN(verificationTime)) ? verificationTime : null,
                createdAt: taskId ? (adminTasksCache[taskId]?.createdAt || firebase.database.ServerValue.TIMESTAMP) : firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

             Object.keys(taskData).forEach(key => { if (taskData[key] === null) { delete taskData[key]; } });

            setStatusMessage(taskFormError, 'Saving...', false, false, true);
            const taskRef = taskId ? db.ref(`tasks/${taskId}`) : db.ref('tasks').push();

            taskRef.set(taskData)
            .then(() => {
                console.log(`Task ${taskId ? 'updated' : 'added'}: ${taskRef.key}`);
                adminTasksCache[taskRef.key] = { ...taskData, createdAt: taskData.createdAt || Date.now(), updatedAt: Date.now() };
                hideTaskForm();
                loadAdminTasks();
                showFlashMessage(`Task "${name}" ${taskId ? 'updated' : 'saved'} successfully.`, 'success');
            })
            .catch(error => {
                console.error("Error saving task:", error);
                setStatusMessage(taskFormError, `Save Error: ${error.message}`, true);
            });
        }

        function handleDeleteTask(taskId) { const taskName = adminTasksCache[taskId]?.name || taskId; if (!confirm(`DELETE TASK "${taskName}"?\n\nThis action cannot be undone!`)) return; if (!confirm(`FINAL WARNING: Really delete task "${taskName}"?`)) return; if (!db) return; db.ref(`tasks/${taskId}`).remove().then(() => { console.log(`Task ${taskId} deleted.`); delete adminTasksCache[taskId]; loadAdminTasks(); showFlashMessage(`Task "${taskName}" deleted successfully.`, 'success'); }).catch(error => { console.error("Error deleting task:", error); showFlashMessage(`Failed to delete task. Error: ${error.message}`, "error"); }); }
        function cacheAdminTasks(tasksData) { adminTasksCache = tasksData || {}; }

        // --- Lucky Code Management ---
        function loadLuckyCodes() { if (!db) return; console.log("Loading lucky codes..."); setStatusMessage(luckyCodeListStatus, 'Loading lucky codes...', false, false, true); luckyCodeTable.style.display = 'none'; luckyCodeTableBody.innerHTML = ''; adminLuckyCodesCache = {}; db.ref('luckyCodes').orderByChild('createdAt').once('value').then(snapshot => { adminLuckyCodesCache = snapshot.val() || {}; const codesData = adminLuckyCodesCache; let count = 0; if (codesData && Object.keys(codesData).length > 0) { Object.keys(codesData).reverse().forEach(codeId => { renderLuckyCodeRow(codeId, codesData[codeId]); count++; }); luckyCodeTable.style.display = 'table'; setStatusMessage(luckyCodeListStatus, '', false); } else { renderEmptyRow(luckyCodeTableBody, 5, "No lucky codes found."); luckyCodeTable.style.display = 'table'; setStatusMessage(luckyCodeListStatus, '', false); } loadDashboardStats(); }).catch(error => { console.error("Error loading lucky codes:", error); setStatusMessage(luckyCodeListStatus, 'Error loading lucky codes. Check console.', true); adminLuckyCodesCache = {}; renderEmptyRow(luckyCodeTableBody, 5, "Error loading lucky codes."); luckyCodeTable.style.display = 'table'; }); }
        function renderLuckyCodeRow(codeId, codeData) { const row = luckyCodeTableBody.insertRow(); row.dataset.codeId = codeId; const now = Date.now(); let expiryText = '<span class="text-muted">Never</span>'; let statusText = 'Active'; let statusClass = 'status-active'; let isExpired = false; if (codeData.expiryTimestamp) { const expiryDate = new Date(codeData.expiryTimestamp); expiryText = expiryDate.toLocaleString(); if (codeData.expiryTimestamp < now) { isExpired = true; statusText = 'Expired'; statusClass = 'status-expired'; row.classList.add('dimmed'); } } row.innerHTML = ` <td><code>${escapeHtml(codeData.code || 'ERROR')}</code></td> <td>${formatAdminNumber(codeData.reward || 0)} <i class="material-icons" style="font-size:1em; color:var(--box-yellow); vertical-align:middle;">monetization_on</i></td> <td>${expiryText}</td> <td><span class="status-indicator ${statusClass}"></span>${statusText}</td> <td class="table-actions"> <button class="btn btn-warning btn-xs" onclick="showEditLuckyCodeForm('${codeId}')" title="Edit Code"${isExpired ? ' disabled' : ''}><i class="material-icons">edit</i></button> <button class="btn btn-danger btn-xs" onclick="handleDeleteLuckyCode('${codeId}')" title="Delete Code"><i class="material-icons">delete</i></button> </td> `; }
        function showAddLuckyCodeForm() { luckyCodeFormBox.style.display = 'block'; luckyCodeFormTitle.textContent = 'Add New Lucky Code'; luckyCodeForm.reset(); luckyCodeEditIdInput.value = ''; setStatusMessage(luckyCodeFormError, '', false); luckyCodeCodeInput.disabled = false; luckyCodeFormBox.scrollIntoView({ behavior: 'smooth', block: 'start' }); luckyCodeCodeInput.focus(); }
        function showEditLuckyCodeForm(codeId) { const codeData = adminLuckyCodesCache[codeId]; if (!codeData) { showFlashMessage("Code data not found. Please refresh.", "error"); return; } luckyCodeFormBox.style.display = 'block'; luckyCodeFormTitle.textContent = 'Edit Lucky Code'; luckyCodeForm.reset(); luckyCodeEditIdInput.value = codeId; luckyCodeCodeInput.value = codeData.code || ''; luckyCodeRewardInput.value = codeData.reward || 0; setStatusMessage(luckyCodeFormError, '', false); luckyCodeCodeInput.disabled = true; luckyCodeExpiryInput.value = ''; if (codeData.expiryTimestamp) { try { const dt = new Date(codeData.expiryTimestamp); const timezoneOffset = dt.getTimezoneOffset() * 60000; const localISOTime = new Date(dt.getTime() - timezoneOffset).toISOString().slice(0, 16); luckyCodeExpiryInput.value = localISOTime; } catch (e) { console.error("Error parsing expiry timestamp for input:", e); } } luckyCodeFormBox.scrollIntoView({ behavior: 'smooth', block: 'start' }); luckyCodeRewardInput.focus(); }
        function hideLuckyCodeForm() { luckyCodeFormBox.style.display = 'none'; luckyCodeForm.reset(); luckyCodeEditIdInput.value = ''; setStatusMessage(luckyCodeFormError, '', false); luckyCodeCodeInput.disabled = false; }
        function handleLuckyCodeFormSubmit(event) { event.preventDefault(); if (!db) return; setStatusMessage(luckyCodeFormError, '', false); const editId = luckyCodeEditIdInput.value; const code = luckyCodeCodeInput.value.trim().toUpperCase(); const reward = parseInt(luckyCodeRewardInput.value); const expiryInputVal = luckyCodeExpiryInput.value; let expiryTimestamp = null; if (!code) { setStatusMessage(luckyCodeFormError, "Code is required.", true); luckyCodeCodeInput.focus(); return; } if (isNaN(reward) || reward <= 0) { setStatusMessage(luckyCodeFormError, "Reward must be a positive number.", true); luckyCodeRewardInput.focus(); return; } if (!editId) { for (const existingId in adminLuckyCodesCache) { if (adminLuckyCodesCache[existingId].code === code) { setStatusMessage(luckyCodeFormError, `Code "${code}" already exists. Choose a different one.`, true); luckyCodeCodeInput.focus(); return; } } } if (expiryInputVal) { try { expiryTimestamp = new Date(expiryInputVal).getTime(); if (isNaN(expiryTimestamp)) throw new Error("Invalid date format"); } catch (e) { setStatusMessage(luckyCodeFormError, `Invalid Expiry Date/Time format: ${e.message}`, true); luckyCodeExpiryInput.focus(); return; } } setStatusMessage(luckyCodeFormError, 'Saving...', false, false, true); const codeData = { code: code, reward: reward, expiryTimestamp: expiryTimestamp, createdAt: editId ? (adminLuckyCodesCache[editId]?.createdAt || firebase.database.ServerValue.TIMESTAMP) : firebase.database.ServerValue.TIMESTAMP, updatedAt: firebase.database.ServerValue.TIMESTAMP }; if (codeData.expiryTimestamp === null) delete codeData.expiryTimestamp; const codeRefKey = editId || db.ref('luckyCodes').push().key; const codeRef = db.ref(`luckyCodes/${codeRefKey}`); codeRef.set(codeData).then(() => { console.log(`Lucky Code ${editId ? 'updated' : 'added'}: ${codeRefKey} (${code})`); adminLuckyCodesCache[codeRefKey] = { ...codeData, createdAt: codeData.createdAt || Date.now(), updatedAt: Date.now() }; hideLuckyCodeForm(); loadLuckyCodes(); showFlashMessage(`Lucky Code "${code}" ${editId ? 'updated' : 'saved'} successfully.`, 'success'); }).catch(error => { console.error("Error saving lucky code:", error); setStatusMessage(luckyCodeFormError, `Save Error: ${error.message}`, true); }); }
        function handleDeleteLuckyCode(codeId) { const codeData = adminLuckyCodesCache[codeId]; const codeName = codeData?.code || codeId; if (!confirm(`DELETE Lucky Code "${codeName}"?\n\nThis action cannot be undone!`)) return; if (!confirm(`FINAL WARNING: Really delete code "${codeName}"?`)) return; if (!db) return; db.ref(`luckyCodes/${codeId}`).remove().then(() => { console.log(`Lucky Code ${codeId} deleted.`); delete adminLuckyCodesCache[codeId]; loadLuckyCodes(); showFlashMessage(`Lucky Code "${codeName}" deleted successfully.`, 'success'); }).catch(error => { console.error("Error deleting lucky code:", error); showFlashMessage(`Failed to delete lucky code. Error: ${error.message}`, "error"); }); }

        // --- Message Templates Management ---
        function loadTemplates(isDependency = false) { if (!db) return; if (!isDependency) { console.log("Loading message templates..."); setStatusMessage(templateListStatus, 'Loading templates...', false, false, true); templateTable.style.display = 'none'; templateTableBody.innerHTML = ''; } db.ref('messageTemplates').orderByChild('name').once('value').then(snapshot => { adminTemplatesCache = snapshot.val() || {}; if (!isDependency) { const templatesData = adminTemplatesCache; let count = 0; if (templatesData && Object.keys(templatesData).length > 0) { Object.keys(templatesData).forEach(templateId => { renderTemplateRow(templateId, templatesData[templateId]); count++; }); templateTable.style.display = 'table'; setStatusMessage(templateListStatus, '', false); } else { renderEmptyRow(templateTableBody, 3, "No templates found."); templateTable.style.display = 'table'; setStatusMessage(templateListStatus, '', false); } } if (isDependency || document.getElementById('send-message-modal')?.classList.contains('visible')) populateTemplateDropdown(sendMessageTemplateSelect, adminTemplatesCache, '-- Manual Message --'); if (isDependency || document.getElementById('autopilot')?.classList.contains('active')) { populateTemplateDropdown(autopilotTemplateSelect, adminTemplatesCache, '-- None (Disable Welcome Message) --'); if (adminAutopilotConfigCache?.welcomeMessage?.templateId) autopilotTemplateSelect.value = adminAutopilotConfigCache.welcomeMessage.templateId; } }).catch(error => { console.error("Error loading templates:", error); adminTemplatesCache = {}; if (!isDependency) { setStatusMessage(templateListStatus, 'Error loading templates. Check console.', true); renderEmptyRow(templateTableBody, 3, "Error loading templates."); templateTable.style.display = 'table'; } }); }
        function renderTemplateRow(templateId, templateData) { const row = templateTableBody.insertRow(); row.dataset.templateId = templateId; let preview = escapeHtml(templateData.text || '').substring(0, 80); if ((templateData.text || '').length > 80) preview += '...'; if (templateData.image) preview += ` <i class="material-icons text-muted" title="Includes Image" style="font-size: 1.1em; vertical-align: text-bottom;">image</i>`; if (templateData.buttons && templateData.buttons.length > 0) preview += ` <i class="material-icons text-muted" title="Includes Buttons" style="font-size: 1.1em; vertical-align: text-bottom;">smart_button</i>`; row.innerHTML = ` <td><strong class="text-bold">${escapeHtml(templateData.name || 'Untitled')}</strong></td> <td><small>${preview || '<span class="text-muted">[No Text Content]</span>'}</small></td> <td class="table-actions"> <button class="btn btn-warning btn-xs" onclick="showEditTemplateForm('${templateId}')" title="Edit Template"><i class="material-icons">edit</i></button> <button class="btn btn-danger btn-xs" onclick="handleDeleteTemplate('${templateId}')" title="Delete Template"><i class="material-icons">delete</i></button> </td> `; }
        function showAddTemplateForm() { templateFormBox.style.display = 'block'; templateFormTitle.textContent = 'Create New Template'; templateForm.reset(); templateEditIdInput.value = ''; templateButtonsContainer.innerHTML = ''; templateButtonsPlaceholder.style.display = 'block'; setStatusMessage(templateFormError, '', false); templateFormBox.scrollIntoView({ behavior: 'smooth', block: 'start' }); templateNameInput.focus(); }
        function showEditTemplateForm(templateId) { const templateData = adminTemplatesCache[templateId]; if (!templateData) { showFlashMessage("Template data not found. Please refresh.", "error"); return; } templateFormBox.style.display = 'block'; templateFormTitle.textContent = 'Edit Template'; templateForm.reset(); templateEditIdInput.value = templateId; templateNameInput.value = templateData.name || ''; templateTextInput.value = templateData.text || ''; templateImageInput.value = templateData.image || ''; templateButtonsContainer.innerHTML = ''; templateButtonsPlaceholder.style.display = 'block'; setStatusMessage(templateFormError, '', false); if (templateData.buttons && Array.isArray(templateData.buttons)) { templateButtonsPlaceholder.style.display = 'none'; templateData.buttons.forEach(buttonRow => { if (Array.isArray(buttonRow) && buttonRow.length > 0) addTemplateButtonRow(buttonRow[0].text, buttonRow[0].url); }); } templateFormBox.scrollIntoView({ behavior: 'smooth', block: 'start' }); templateNameInput.focus(); }
        function hideTemplateForm() { templateFormBox.style.display = 'none'; templateForm.reset(); templateEditIdInput.value = ''; templateButtonsContainer.innerHTML = ''; templateButtonsPlaceholder.style.display = 'block'; setStatusMessage(templateFormError, '', false); }
        function addTemplateButtonRow(labelText = '', urlText = '') { if (templateButtonsContainer.children.length >= 5) { showFlashMessage("Maximum of 5 button rows allowed.", "warning"); return; } templateButtonsPlaceholder.style.display = 'none'; const div = document.createElement('div'); div.className = 'inline-button-row'; div.innerHTML = ` <input type="text" class="form-control template-button-label" placeholder="Button Label" value="${escapeHtml(labelText)}" required> <input type="url" class="form-control template-button-url" placeholder="Button URL (https://...)" value="${escapeHtml(urlText)}" required> <button type="button" class="btn btn-danger btn-xs" onclick="removeButtonRow(this, 'template-buttons-placeholder')" title="Remove Row"><i class="material-icons">remove_circle_outline</i></button> `; templateButtonsContainer.appendChild(div); }
        function handleTemplateFormSubmit(event) { event.preventDefault(); if (!db) return; setStatusMessage(templateFormError, '', false); const templateId = templateEditIdInput.value; const name = templateNameInput.value.trim(); const text = templateTextInput.value.trim(); const image = templateImageInput.value.trim(); const buttons = []; let buttonsValid = true; if (!name) { setStatusMessage(templateFormError, "Template Name is required.", true); templateNameInput.focus(); return; } if (!text && !image) { setStatusMessage(templateFormError, "Template must have Text or an Image URL.", true); templateTextInput.focus(); return; } try { if (image) new URL(image); } catch (_) { setStatusMessage(templateFormError, "Image URL is invalid.", true); templateImageInput.focus(); return; } const buttonRows = templateButtonsContainer.querySelectorAll('.inline-button-row'); buttonRows.forEach(row => { const labelInput = row.querySelector('.template-button-label'); const urlInput = row.querySelector('.template-button-url'); const label = labelInput?.value.trim(); const url = urlInput?.value.trim(); if (label && url) { try { new URL(url); buttons.push([{ text: label, url: url }]); } catch (_) { buttonsValid = false; urlInput?.focus(); } } else if (label || url) { buttonsValid = false; if (!label) labelInput?.focus(); else urlInput?.focus(); } }); if (!buttonsValid) { setStatusMessage(templateFormError, 'Error: Incomplete or invalid button label/URL.', true); return; } setStatusMessage(templateFormError, 'Saving...', false, false, true); const templateData = { name: name, text: text || null, image: image || null, buttons: buttons.length > 0 ? buttons : null, createdAt: templateId ? (adminTemplatesCache[templateId]?.createdAt || firebase.database.ServerValue.TIMESTAMP) : firebase.database.ServerValue.TIMESTAMP, updatedAt: firebase.database.ServerValue.TIMESTAMP }; Object.keys(templateData).forEach(key => { if (templateData[key] === null) delete templateData[key]; }); const templateRef = templateId ? db.ref(`messageTemplates/${templateId}`) : db.ref('messageTemplates').push(); templateRef.set(templateData).then(() => { console.log(`Template ${templateId ? 'updated' : 'added'}: ${templateRef.key}`); adminTemplatesCache[templateRef.key] = { ...templateData, createdAt: templateData.createdAt || Date.now(), updatedAt: Date.now() }; hideTemplateForm(); loadTemplates(); showFlashMessage(`Template "${name}" ${templateId ? 'updated' : 'saved'} successfully.`, 'success'); }).catch(error => { console.error("Error saving template:", error); setStatusMessage(templateFormError, `Save Error: ${error.message}`, true); }); }
        function handleDeleteTemplate(templateId) { const templateData = adminTemplatesCache[templateId]; const templateName = templateData?.name || templateId; if (!confirm(`DELETE Template "${templateName}"?\n\nThis action cannot be undone!`)) return; if (!confirm(`FINAL WARNING: Really delete template "${templateName}"?`)) return; if (!db) return; db.ref(`messageTemplates/${templateId}`).remove().then(() => { console.log(`Template ${templateId} deleted.`); delete adminTemplatesCache[templateId]; loadTemplates(); showFlashMessage(`Template "${templateName}" deleted successfully.`, 'success'); }).catch(error => { console.error("Error deleting template:", error); showFlashMessage(`Failed to delete template. Error: ${error.message}`, "error"); }); }

        // --- Autopilot Configuration ---
        function loadAutopilotConfig() {
            if (!db) return;
            console.log("Loading Autopilot config...");
            setStatusMessage(autopilotTaskStatus, 'Loading settings...', false, false, true);
            setStatusMessage(autopilotWelcomeStatus, 'Loading settings...', false, false, true);
            autopilotTaskSelect.innerHTML = '<option value="">-- Loading Tasks --</option>';
            autopilotTemplateSelect.innerHTML = '<option value="">-- Loading Templates --</option>';

            db.ref('autopilotConfig').once('value')
            .then(snapshot => {
                adminAutopilotConfigCache = snapshot.val() || {};
                loadAdminTasks(true);
                loadTemplates(true);

                const welcomeConfig = adminAutopilotConfigCache.welcomeMessage;
                const totalMilliseconds = welcomeConfig?.delayMilliseconds || 0;
                const totalSeconds = Math.floor(totalMilliseconds / 1000);
                autopilotWelcomeDelayMinInput.value = Math.floor(totalSeconds / 60);
                autopilotWelcomeDelaySecInput.value = totalSeconds % 60;
                autopilotWelcomeDelayMsInput.value = totalMilliseconds % 1000;

                setStatusMessage(autopilotTaskStatus, '', false);
                setStatusMessage(autopilotWelcomeStatus, '', false);
            })
            .catch(error => {
                console.error("Error loading autopilot config:", error);
                adminAutopilotConfigCache = {};
                setStatusMessage(autopilotTaskStatus, 'Error loading config.', true);
                setStatusMessage(autopilotWelcomeStatus, 'Error loading config.', true);
                loadAdminTasks(true);
                loadTemplates(true);
                showFlashMessage("Error loading Autopilot settings.", "error");
            });
        }

        function handleSaveRecurringTask(event) { event.preventDefault(); if (!db) return; const selectedTaskId = autopilotTaskSelect.value; const configPath = 'autopilotConfig/recurringTask'; setStatusMessage(autopilotTaskStatus, 'Saving...', false, false, true); let saveOperation; if (selectedTaskId) saveOperation = db.ref(configPath).set({ taskId: selectedTaskId, updatedAt: firebase.database.ServerValue.TIMESTAMP }); else saveOperation = db.ref(configPath).remove(); saveOperation.then(() => { if (selectedTaskId) adminAutopilotConfigCache.recurringTask = { taskId: selectedTaskId }; else delete adminAutopilotConfigCache.recurringTask; setStatusMessage(autopilotTaskStatus, 'Recurring task setting saved!', false, true); console.log("Recurring task config updated."); }).catch(error => { console.error("Error saving recurring task config:", error); setStatusMessage(autopilotTaskStatus, `Save Error: ${error.message}`, true); }); }
        function handleSaveWelcomeMessage(event) { event.preventDefault(); if (!db) return; setStatusMessage(autopilotWelcomeStatus, '', false); const selectedTemplateId = autopilotTemplateSelect.value; const minutes = parseInt(autopilotWelcomeDelayMinInput.value); const seconds = parseInt(autopilotWelcomeDelaySecInput.value); const milliseconds = parseInt(autopilotWelcomeDelayMsInput.value); const configPath = 'autopilotConfig/welcomeMessage'; if (isNaN(minutes) || minutes < 0) { setStatusMessage(autopilotWelcomeStatus, 'Invalid Minutes value (must be >= 0).', true); autopilotWelcomeDelayMinInput.focus(); return; } if (isNaN(seconds) || seconds < 0 || seconds > 59) { setStatusMessage(autopilotWelcomeStatus, 'Invalid Seconds value (must be 0-59).', true); autopilotWelcomeDelaySecInput.focus(); return; } if (isNaN(milliseconds) || milliseconds < 0 || milliseconds > 999) { setStatusMessage(autopilotWelcomeStatus, 'Invalid Milliseconds value (must be 0-999).', true); autopilotWelcomeDelayMsInput.focus(); return; } if (!selectedTemplateId && (minutes + seconds + milliseconds > 0)) { setStatusMessage(autopilotWelcomeStatus, 'Please select a template if setting a delay > 0.', true); autopilotTemplateSelect.focus(); return; } const totalDelayMilliseconds = (minutes * 60 * 1000) + (seconds * 1000) + milliseconds; setStatusMessage(autopilotWelcomeStatus, 'Saving...', false, false, true); let saveOperation; if (selectedTemplateId) saveOperation = db.ref(configPath).set({ templateId: selectedTemplateId, delayMilliseconds: totalDelayMilliseconds, updatedAt: firebase.database.ServerValue.TIMESTAMP }); else saveOperation = db.ref(configPath).remove(); saveOperation.then(() => { if (selectedTemplateId) adminAutopilotConfigCache.welcomeMessage = { templateId: selectedTemplateId, delayMilliseconds: totalDelayMilliseconds }; else delete adminAutopilotConfigCache.welcomeMessage; setStatusMessage(autopilotWelcomeStatus, 'Welcome message setting saved!', false, true); console.log("Welcome message config updated."); }).catch(error => { console.error("Error saving welcome message config:", error); setStatusMessage(autopilotWelcomeStatus, `Save Error: ${error.message}`, true); }); }

        // --- Utility Functions ---
        function formatAdminNumber(num) { if (typeof num !== 'number' || isNaN(num)) return '0'; return num.toLocaleString(); }
        function escapeHtml(unsafe) { if (unsafe === null || typeof unsafe === 'undefined') return ''; return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function showModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.classList.add('visible'); }
        function hideModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.remove('visible'); const statusEl = modal.querySelector('.modal-status, .form-status'); if (statusEl) setStatusMessage(statusEl, '', false); } }
        function setStatusMessage(element, message, isError = false, isSuccess = false, isLoading = false) { if (!element) return; element.textContent = message; element.className = 'form-status modal-status'; if (isError) element.classList.add('error-message'); else if (isSuccess) element.classList.add('success-message'); else if (isLoading) element.classList.add('loading-message'); }
        function populateDropdown(selectElement, dataCache, defaultOptionText) { if (!selectElement) return; const currentValue = selectElement.value; selectElement.innerHTML = `<option value="">${escapeHtml(defaultOptionText)}</option>`; const sortedKeys = Object.keys(dataCache).sort((a, b) => (dataCache[a]?.name || '').localeCompare(dataCache[b]?.name || '')); sortedKeys.forEach(id => { const item = dataCache[id]; const optionText = item.name ? `${item.name} (${id.substring(0, 6)}...)` : `ID: ${id}`; const option = document.createElement('option'); option.value = id; option.textContent = escapeHtml(optionText); if (selectElement === autopilotTaskSelect && item.isActive === false) { return; } selectElement.appendChild(option); }); if (currentValue && selectElement.querySelector(`option[value="${currentValue}"]`)) selectElement.value = currentValue; else selectElement.value = ""; }
        function populateTaskDropdown(selectElement, tasks, defaultText) { populateDropdown(selectElement, tasks, defaultText); }
        function populateTemplateDropdown(selectElement, templates, defaultText) { populateDropdown(selectElement, templates, defaultText); }
        function renderEmptyRow(tbodyElement, colSpan, message = "No data available.") { if (!tbodyElement) return; tbodyElement.innerHTML = `<tr class="table-empty-row"><td colspan="${colSpan}">${escapeHtml(message)}</td></tr>`; }
        function showFlashMessage(message, type = 'info') { const container = document.getElementById('flash-message-container') || document.body; const flashDiv = document.createElement('div'); flashDiv.className = `flash-message ${type}`; flashDiv.textContent = message; container.appendChild(flashDiv); requestAnimationFrame(() => { flashDiv.classList.add('show'); }); setTimeout(() => { flashDiv.classList.remove('show'); setTimeout(() => { flashDiv.remove(); }, 400); }, 3500); }


    </script>
</body>
</html>